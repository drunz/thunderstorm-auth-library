Thunderstorm Auth Library
=========================

Thunderstorm auth library assists in using [JWTs](https://jwt.io/) generated by the
[Thunderstorm User Service](https://github.com/artsalliancemedia/thunderstorm-user-service).

**Note: This is a public repo**


Installation
------------

Install this library from a tarball on Github.
Optionally add the web framework of choice as an extra to install extra
components for those frameworks.

e.g. for Flask:
```
pip install https://github.com/artsalliancemedia/thunderstorm-auth-library/releases/download/vX.Y.Z/thunderstorm-auth-lib-X.Y.Z.tar.gz
pip install thunderstorm-auth-lib[flask]
```


Requirements
------------

You will need to include the config variable `TS_AUTH_JWKS` in your Flask config. The JWKs stored in this variable
will be used for decoding JWTs.
[Thunderstorm User Service](https://github.com/artsalliancemedia/thunderstorm-user-service#using-your-jwt).


How to Use
----------

### Flask

The following decorator will make your views require the JWT issued by the `thunderstorm-user-service`.

```python
from thunderstorm_auth.flask import ts_auth_required

@route('/hello', methods=['GET'])
@ts_auth_required
def hello():
    return jsonify({'message': 'hello world'})
```

When making a request to this endpoint, you must supply your JWT in a HTTP header called
`X-Thunderstorm-Key`.

For example:

```
$ http localhost:8888/hello X-Thunderstorm-Key:eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VybmFtZSI6Im1hZnJvMiIsInBlcm1pc3Npb25zIjoiKiIsImV4cCI6MTUwMTg0NTk0OH0.uhRFnfqIaZ91A5xgbqKqQPjdBuOYsuMzIEHA7-j0mzM
HTTP/1.0 200 OK
Content-Length: 31
Content-Type: application/json
Date: Fri, 04 Aug 2017 09:55:19 GMT
Server: Werkzeug/0.12.2 Python/3.5.3

{
    "message": "hello world"
}
```

When authentication fails:

```
$ http localhost:8888/hello X-Thunderstorm-Key:egg
HTTP/1.0 401 UNAUTHORIZED
Content-Length: 48
Content-Type: application/json
Date: Fri, 04 Aug 2017 11:37:40 GMT
Server: Werkzeug/0.12.2 Python/3.5.3

{
    "message": "Token authentication failed."
}
```

If this header is missing, the request will receive a 401:

```
$ http localhost:8888/hello
HTTP/1.0 401 UNAUTHORIZED
Content-Length: 53
Content-Type: application/json
Date: Fri, 04 Aug 2017 09:55:24 GMT
Server: Werkzeug/0.12.2 Python/3.5.3

{
    "message": "Missing X-Thunderstorm-Key header"
}
```


Exceptions
----------

The exception `AuthJwksNotSet` will be raised when `TS_AUTH_JWKS` is missing from the
Flask config.

Both Flask and Falcon raise the following exceptions:
`ExpiredTokenError` - If the token supplied for decoding has expired.
`BrokenTokenError` - If the token supplied was malformed or the token does not match the JWK indicated in its 'Headers' section.

Installing the library for dev
------------------------------

First you will need to pick a service to develop against.

If, for example, you are working on the `complex-service`, first clone this repo as a subdirectory
of that project.

    complex-service/
    complex-service/Makefile
    complex-service/docker-compose.yml
    complex-service/complex_service/
    complex-service/test/
    complex-service/thunderstorm-auth-library/

Next, modify the installation of the auth library. The [complex-service](https://github.com/artsalliancemedia/complex-service/blob/master/env_conf/Dockerfile#L27)
has a line in its `Dockerfile` installing this library from a tarball. Change this line to the
following two lines:

    COPY thunderstorm-auth-library /var/app/thunderstorm-auth-library
    RUN pip install -e file:/var/app/thunderstorm-auth-library

Avoiding Exchange Not Found errors in tests
-------------------------------------------

By default an Exchange Not Found error is raised by `init_group_sync_tasks` if
the exchange does not exist. This is useful in deployed environments where
we want to avoid an app silently not binding to the correct exchange. However,
this causes tests to fail because there is no exchange there. To avoid this
set `ensure_exchange_exists` to `False`.


Creating a new release
----------------------

New releases can be easily created using [github-release](https://github.com/aktau/github-release).
Increment the version number in [`thunderstorm_auth/__init__.py`](./thunderstorm_auth/__init__.py)
and run the following command:

    make release
